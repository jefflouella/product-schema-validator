<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report_title or "Product Schema Validation Report" }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* Modern Header Styling */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 2rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .logo-container {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .header-title {
            font-family: 'Inter', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }
        
        .header-right {
            text-align: right;
        }
        
        .generated-time {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        #dashboardHeader.collapsed .page-header {
            padding: 0.75rem 0;
            margin-bottom: 1rem;
        }
        
        #dashboardHeader.collapsed .logo-container {
            width: 40px;
            height: 40px;
        }
        
        #dashboardHeader.collapsed .header-title {
            font-size: 1.2rem;
        }
        
        #dashboardHeader.collapsed .generated-time {
            font-size: 0.65rem;
        }
        
        .status-success { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .status-no_schema { color: #ff8c00; }
        .status-blocked { color: #6c757d; }
        .table-responsive { max-height: 600px; overflow-y: auto; }
        .score-badge { font-size: 0.8em; }
        .filter-section { background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem; }
        
        /* URL cell wrapping */
        .url-cell {
            max-width: 400px;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        
        .url-cell a {
            display: inline-block;
            width: 100%;
        }
        
        /* Collapsible dashboard header */
        #dashboardHeader {
            transition: all 0.3s ease;
        }
        
        #dashboardHeader.collapsed .summary-cards,
        #dashboardHeader.collapsed .charts-section {
            display: none;
        }
        
        #dashboardHeader.collapsed h1 {
            font-size: 1.2rem;
            margin: 0.5rem 0;
        }
        
        #dashboardHeader.collapsed {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.5rem 0;
        }
        
        #toggleHeader {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 101;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .compact-stats {
            display: none;
            font-size: 0.9rem;
        }
        
        #dashboardHeader.collapsed .compact-stats {
            display: inline-flex;
            gap: 1rem;
            margin-left: 1rem;
        }
        
        .compact-stats span {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }
        
        /* Modal overlay styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            padding: 0;
        }
        
        .modal-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        /* Error and warning highlighting */
        .error-highlight {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .warning-highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .path-display {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.9em;
            margin: 0.25rem 0;
        }
        
        .copy-path-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .copy-path-btn:hover {
            background: #0056b3;
        }
        
        .explanation-text {
            font-style: italic;
            color: #6c757d;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Toggle Button -->
    <button id="toggleHeader" class="btn btn-primary btn-sm" title="Collapse/Expand Dashboard">
        <i class="fas fa-chevron-up" id="toggleIcon"></i>
    </button>
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div id="dashboardHeader">
                    <div class="page-header">
                        <div class="header-left">
                            <div class="logo-container">
                                <img src="logo.png" alt="Product Schema Validator" onerror="this.style.display='none'">
                            </div>
                            <h1 class="header-title">
                                {{ report_title or "Product Schema Validation Report" }}
                                <span class="compact-stats">
                                    <span class="bg-success text-white">✓ {{ summary.success }}</span>
                                    <span class="bg-warning text-dark">⚠ {{ summary.warning }}</span>
                                    <span class="bg-danger text-white">✗ {{ summary.error }}</span>
                                    <span class="text-muted">Total: {{ summary.total }}</span>
                                </span>
                            </h1>
                        </div>
                        <div class="header-right">
                            <div class="generated-time">Generated: {{ generation_time }}</div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards">
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-primary">{{ summary.total }}</h5>
                                <p class="card-text">Total URLs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">{{ summary.success }}</h5>
                                <p class="card-text">Success</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">{{ summary.warning }}</h5>
                                <p class="card-text">Warning</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-danger">{{ summary.error }}</h5>
                                <p class="card-text">Error</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title" style="color: #ff8c00;">{{ summary.no_schema }}</h5>
                                <p class="card-text">No Schema</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-secondary">{{ summary.blocked }}</h5>
                                <p class="card-text">Blocked</p>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- End summary-cards -->
                
                    <!-- Charts -->
                    <div class="charts-section">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Status Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="statusChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Schema Coverage</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="schemaChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Common Issues</h5>
                            </div>
                            <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                                <table class="table table-sm table-hover" id="issuesTable">
                                    <thead>
                                        <tr>
                                            <th>Issue</th>
                                            <th class="text-center">Count</th>
                                            <th class="text-center">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- End charts-section -->
                </div> <!-- End dashboardHeader -->
                
                <!-- Filters -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Status Filter:</label>
                            <select id="statusFilter" class="form-select">
                                <option value="">All</option>
                                <option value="success">Success</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="schemaFilter" class="form-label">Schema Found:</label>
                            <select id="schemaFilter" class="form-select">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">Search URL:</label>
                            <input type="text" id="searchInput" class="form-control" placeholder="Search URLs...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button id="exportExcel" class="btn btn-success">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                                <button id="exportCsv" class="btn btn-outline-primary">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                                <button id="clearFilters" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Table -->
                <div class="card">
                    <div class="card-header">
                        <h5>Validation Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="resultsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>URL</th>
                                        <th>Status</th>
                                        <th>Schema</th>
                                        <th>Score</th>
                                        <th>Response Time</th>
                                        <th>Issues</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in results %}
                                    <tr data-status="{{ result.status }}" data-schema="{{ result.schema_found|lower }}">
                                        <td class="url-cell">
                                            <a href="{{ result.url }}" target="_blank" class="text-decoration-none">
                                                {{ result.url }}
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge status-{{ result.status }}">
                                                {% if result.status == 'success' %}
                                                    <i class="fas fa-check"></i> Success
                                                {% elif result.status == 'warning' %}
                                                    <i class="fas fa-exclamation-triangle"></i> Warning
                                                {% elif result.status == 'error' %}
                                                    <i class="fas fa-times"></i> Error
                                                {% elif result.status == 'no_schema' %}
                                                    <i class="fas fa-file-excel"></i> No Schema
                                                {% elif result.status == 'blocked' %}
                                                    <i class="fas fa-shield-alt"></i> Blocked
                                                {% else %}
                                                    <i class="fas fa-question"></i> Unknown
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            {% if result.schema_found %}
                                                <span class="badge bg-success"><i class="fas fa-check"></i> Found</span>
                                            {% else %}
                                                <span class="badge bg-danger"><i class="fas fa-times"></i> Not Found</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if result.score > 0 %}
                                                <span class="badge score-badge {% if result.score >= 80 %}bg-success{% elif result.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ result.score }}%
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ result.response_time }}s</td>
                                        <td>
                                            {% if result.errors %}
                                                <span class="text-danger" title="{{ result.errors|join('; ') }}">
                                                    <i class="fas fa-exclamation-circle"></i> {{ result.errors|length }} errors
                                                </span>
                                            {% endif %}
                                            {% if result.warnings %}
                                                <span class="text-warning" title="{{ result.warnings|join('; ') }}">
                                                    <i class="fas fa-exclamation-triangle"></i> {{ result.warnings|length }} warnings
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="showDetails({{ loop.index }})">
                                                <i class="fas fa-eye"></i> Details
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Overlay -->
    <div id="detailsModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h5 class="modal-title">Schema Details</h5>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart.js configuration
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Success', 'Warning', 'Error'],
                datasets: [{
                    data: [{{ summary.success }}, {{ summary.warning }}, {{ summary.error }}],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        const schemaCtx = document.getElementById('schemaChart').getContext('2d');
        new Chart(schemaCtx, {
            type: 'doughnut',
            data: {
                labels: ['Schema Found', 'No Schema'],
                datasets: [{
                    data: [{{ summary.schema_found }}, {{ summary.total - summary.schema_found }}],
                    backgroundColor: ['#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Populate Common Issues table
        function populateIssuesTable() {
            try {
                const dataScript = document.getElementById('results-data');
                if (!dataScript) {
                    console.error('results-data script tag not found');
                    return;
                }
                
                const results = JSON.parse(dataScript.textContent);
                console.log('Loaded results:', results.length);
                
                // Count all errors and warnings with type tracking
                const issueCounts = {};
                let totalWithSchema = 0;
                
                results.forEach(result => {
                    if (result.schema_found && result.validation) {
                        totalWithSchema++;
                        
                        // Count errors
                        if (result.validation.errors && Array.isArray(result.validation.errors)) {
                            result.validation.errors.forEach(error => {
                                const msg = typeof error === 'string' ? error : error.message;
                                if (msg) {
                                    if (!issueCounts[msg]) {
                                        issueCounts[msg] = { count: 0, type: 'error' };
                                    }
                                    issueCounts[msg].count++;
                                }
                            });
                        }
                        
                        // Count warnings
                        if (result.validation.warnings && Array.isArray(result.validation.warnings)) {
                            result.validation.warnings.forEach(warning => {
                                const msg = typeof warning === 'string' ? warning : warning.message;
                                if (msg) {
                                    if (!issueCounts[msg]) {
                                        issueCounts[msg] = { count: 0, type: 'warning' };
                                    }
                                    issueCounts[msg].count++;
                                }
                            });
                        }
                    }
                });
                
                console.log('Total with schema and validation:', totalWithSchema);
                console.log('Issue counts:', issueCounts);
                
                // Sort by count (descending)
                const sortedIssues = Object.entries(issueCounts)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 10); // Top 10 issues
                
                // Populate table
                const tbody = document.querySelector('#issuesTable tbody');
                if (!tbody) {
                    console.error('Table tbody not found');
                    return;
                }
                
                tbody.innerHTML = '';
                
                if (sortedIssues.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Processing... (issues will appear as URLs are validated)</td></tr>';
                } else {
                    sortedIssues.forEach(([issue, data]) => {
                        const percentage = totalWithSchema > 0 ? Math.round((data.count / totalWithSchema) * 100) : 0;
                        const row = document.createElement('tr');
                        
                        // Truncate long issue names
                        let displayIssue = issue;
                        if (issue.length > 50) {
                            displayIssue = issue.substring(0, 47) + '...';
                        }
                        
                        // Colored indicator based on type
                        const indicator = data.type === 'error' 
                            ? '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:#dc3545;margin-right:8px;" title="Error"></span>'
                            : '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:#ffc107;margin-right:8px;" title="Warning"></span>';
                        
                        row.innerHTML = `
                            <td title="${issue}">${indicator}${displayIssue}</td>
                            <td class="text-center"><span class="badge bg-secondary">${data.count}</span></td>
                            <td class="text-center">${percentage}%</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error('Error populating issues table:', e);
                const tbody = document.querySelector('#issuesTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading data</td></tr>';
                }
            }
        }
        
        // Call on page load
        document.addEventListener('DOMContentLoaded', populateIssuesTable);
        
        // Dashboard collapse/expand toggle
        document.getElementById('toggleHeader').addEventListener('click', () => {
            const header = document.getElementById('dashboardHeader');
            const icon = document.getElementById('toggleIcon');
            
            header.classList.toggle('collapsed');
            
            if (header.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-down';
            } else {
                icon.className = 'fas fa-chevron-up';
            }
        });
        
        // Auto-collapse on scroll (optional - can be removed if you prefer manual only)
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const header = document.getElementById('dashboardHeader');
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            // Collapse when scrolling down past 300px
            if (scrollTop > 300 && scrollTop > lastScrollTop) {
                header.classList.add('collapsed');
                document.getElementById('toggleIcon').className = 'fas fa-chevron-down';
            }
            
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        }, false);
        
        // Filter functionality
        function filterTable() {
            const statusFilter = document.getElementById('statusFilter').value;
            const schemaFilter = document.getElementById('schemaFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            const rows = document.querySelectorAll('#resultsTable tbody tr');
            rows.forEach(row => {
                if (row.id.startsWith('details-')) return; // Skip detail rows
                
                const status = row.dataset.status;
                const schema = row.dataset.schema;
                const url = row.querySelector('td a').textContent.toLowerCase();
                
                const statusMatch = !statusFilter || status === statusFilter;
                const schemaMatch = !schemaFilter || schema === schemaFilter;
                const searchMatch = !searchInput || url.includes(searchInput);
                
                row.style.display = (statusMatch && schemaMatch && searchMatch) ? '' : 'none';
            });
        }
        
        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', filterTable);
        document.getElementById('schemaFilter').addEventListener('change', filterTable);
        document.getElementById('searchInput').addEventListener('input', filterTable);
        
        document.getElementById('clearFilters').addEventListener('click', () => {
            document.getElementById('statusFilter').value = '';
            document.getElementById('schemaFilter').value = '';
            document.getElementById('searchInput').value = '';
            filterTable();
        });
        
        document.getElementById('exportExcel').addEventListener('click', () => {
            // Generate Excel file via Python script
            fetch('generate_excel', {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    // Download the generated file
                    window.location.href = 'validation_report.xlsx';
                    alert('Excel report generated! Check your downloads folder for validation_report.xlsx');
                } else {
                    alert('Excel generation is available via command line. Run: python3 excel_exporter.py');
                    console.log('To generate Excel report, run: python3 excel_exporter.py');
                }
            }).catch(error => {
                // Fallback: Generate via command line
                alert('Excel generation requires running: python3 excel_exporter.py\n\nThe styled Excel file will be saved to results/validation_report.xlsx');
                console.log('To generate styled Excel report, run: python3 excel_exporter.py');
            });
        });
        
        document.getElementById('exportCsv').addEventListener('click', () => {
            try {
                const results = loadResultsData();
                
                if (!results || results.length === 0) {
                    alert('No results to export yet. Please wait for validation to process some URLs.');
                    return;
                }
                
                // Create CSV content
                let csv = 'URL,Status,Schema Found,Validation Score,# of Errors,# of Warnings,Errors,Warnings,Response Time\n';
                
                results.forEach(result => {
                    const url = result.url.replace(/"/g, '""'); // Escape quotes
                    const status = result.status || 'unknown';
                    const schemaFound = result.schema_found ? 'Yes' : 'No';
                    
                    // Get score from either validation object or top-level score field
                    let score = 0;
                    if (result.validation && result.validation.score !== undefined) {
                        score = result.validation.score;
                    } else if (result.score !== undefined) {
                        score = result.score;
                    }
                    
                    // Extract error messages from validation or top-level errors
                    let errors = '';
                    let errorCount = 0;
                    if (result.validation && result.validation.errors) {
                        errorCount = result.validation.errors.length;
                        errors = result.validation.errors.map(e => 
                            typeof e === 'string' ? e : (e.message || '')
                        ).join('; ').replace(/"/g, '""');
                    } else if (result.errors && Array.isArray(result.errors)) {
                        errorCount = result.errors.length;
                        errors = result.errors.map(e => 
                            typeof e === 'string' ? e : (e.message || '')
                        ).join('; ').replace(/"/g, '""');
                    } else if (result.error) {
                        errorCount = 1;
                        errors = result.error.replace(/"/g, '""');
                    }
                    
                    // Extract warning messages from validation or top-level warnings
                    let warnings = '';
                    let warningCount = 0;
                    if (result.validation && result.validation.warnings) {
                        warningCount = result.validation.warnings.length;
                        warnings = result.validation.warnings.map(w => 
                            typeof w === 'string' ? w : (w.message || '')
                        ).join('; ').replace(/"/g, '""');
                    } else if (result.warnings && Array.isArray(result.warnings)) {
                        warningCount = result.warnings.length;
                        warnings = result.warnings.map(w => 
                            typeof w === 'string' ? w : (w.message || '')
                        ).join('; ').replace(/"/g, '""');
                    }
                    
                    const responseTime = result.response_time ? result.response_time.toFixed(2) + 's' : 'N/A';
                    
                    csv += `"${url}","${status}","${schemaFound}","${score}%","${errorCount}","${warningCount}","${errors}","${warnings}","${responseTime}"\n`;
                });
                
                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'product_schema_validation_results.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`CSV exported successfully with ${results.length} results`);
            } catch (e) {
                console.error('Error exporting CSV:', e);
                alert('Error exporting CSV: ' + e.message);
            }
        });
        
    </script>
    
    <!-- Results data -->
    <script type="application/json" id="results-data">{{ results|tojson }}</script>
    
    <script>
        // Global results data
        let resultsData = null;
        
        // Load results data safely
        function loadResultsData() {
            if (!resultsData) {
                try {
                    const dataScript = document.getElementById('results-data');
                    resultsData = JSON.parse(dataScript.textContent);
                } catch (e) {
                    console.error('Error loading results data:', e);
                    resultsData = [];
                }
            }
            return resultsData;
        }
        
        // Show details in modal overlay
        function showDetails(index) {
            const modal = document.getElementById('detailsModal');
            const modalBody = document.getElementById('modalBody');
            
            // Get the result data for this index
            const results = loadResultsData();
            const result = results[index - 1]; // Convert to 0-based index
            
            if (!result) {
                console.error('Result not found for index:', index);
                return;
            }
            
            // Build modal content
            let content = '<div class="mb-3">';
            content += '<h6><strong>URL:</strong></h6>';
            content += '<p><a href="' + result.url + '" target="_blank">' + result.url + '</a></p>';
            content += '</div>';
            
            content += '<div class="mb-3">';
            content += '<h6><strong>Status:</strong></h6>';
            content += '<p><span class="badge status-' + result.status + '">' + result.status + '</span></p>';
            content += '</div>';
            
            if (result.schema_found) {
                // Show validation score first
                if (result.validation) {
                    content += '<div class="mb-3">';
                    content += '<h6><strong>Validation Score:</strong></h6>';
                    content += '<p class="h4">' + (result.validation.score || 0) + '%</p>';
                    content += '</div>';
                }
                
                // Show errors FIRST (most important)
                if (result.validation && result.validation.errors && result.validation.errors.length > 0) {
                    content += '<div class="mb-3">';
                    content += '<h6 class="text-danger"><strong>Errors:</strong></h6>';
                    result.validation.errors.forEach(error => {
                        content += '<div class="error-highlight">';
                        
                        // Handle both old format (string) and new format (object)
                        if (typeof error === 'string') {
                            content += '<div class="text-danger"><strong>' + error + '</strong></div>';
                            // Add specific explanations for common errors
                            if (error.includes('price') && error.includes('required')) {
                                content += '<div class="explanation-text">The product price is missing from the offers section. This is required for proper e-commerce functionality.</div>';
                            } else if (error.includes('Missing required offer field')) {
                                content += '<div class="explanation-text">This offer field is required for proper pricing information display.</div>';
                            } else {
                                content += '<div class="explanation-text">This is a validation error that needs to be fixed.</div>';
                            }
                        } else {
                            content += '<div class="text-danger"><strong>' + error.message + '</strong></div>';
                            if (error.path) {
                                content += '<div class="path-display">Path: ' + error.path + 
                                         '<button class="copy-path-btn" data-path="' + error.path + '">Copy Path</button></div>';
                            }
                            if (error.explanation) {
                                content += '<div class="explanation-text">' + error.explanation + '</div>';
                            }
                        }
                        content += '</div>';
                    });
                    content += '</div>';
                }
                
                // Show warnings SECOND
                if (result.validation && result.validation.warnings && result.validation.warnings.length > 0) {
                    content += '<div class="mb-3">';
                    content += '<h6 class="text-warning"><strong>Warnings:</strong></h6>';
                    result.validation.warnings.forEach(warning => {
                        content += '<div class="warning-highlight">';
                        
                        // Handle both old format (string) and new format (object)
                        if (typeof warning === 'string') {
                            content += '<div class="text-warning"><strong>' + warning + '</strong></div>';
                            // Add specific explanations for common warnings
                            if (warning.includes('gtin')) {
                                content += '<div class="explanation-text">GTIN (Global Trade Item Number) is recommended for better product identification and search engine optimization.</div>';
                            } else if (warning.includes('aggregateRating')) {
                                content += '<div class="explanation-text">Product ratings and reviews help with SEO and customer trust.</div>';
                            } else if (warning.includes('review')) {
                                content += '<div class="explanation-text">Customer reviews improve product credibility and search rankings.</div>';
                            } else {
                                content += '<div class="explanation-text">This is a recommended field that would improve SEO.</div>';
                            }
                        } else {
                            content += '<div class="text-warning"><strong>' + warning.message + '</strong></div>';
                            if (warning.path) {
                                content += '<div class="path-display">Path: ' + warning.path + 
                                         '<button class="copy-path-btn" data-path="' + warning.path + '">Copy Path</button></div>';
                            }
                            if (warning.explanation) {
                                content += '<div class="explanation-text">' + warning.explanation + '</div>';
                            }
                        }
                        content += '</div>';
                    });
                    content += '</div>';
                }
                
                // Show schema data LAST (for reference)
                content += '<div class="mb-3">';
                content += '<h6><strong>Schema Data:</strong></h6>';
                if (result.schema_data) {
                    // Highlight problematic fields in the schema data
                    let schemaJson = JSON.stringify(result.schema_data, null, 2);
                    
                    // Highlight missing required fields - check if validation exists first
                    if (result.validation && result.validation.errors) {
                        result.validation.errors.forEach(error => {
                            if (typeof error === 'string' && error.includes('Missing required field')) {
                                const field = error.replace('Missing required field: ', '');
                                schemaJson = schemaJson.replace(new RegExp('"' + field + '"', 'g'), '<span class="text-danger bg-danger bg-opacity-10 fw-bold">"' + field + '"</span>');
                            }
                        });
                    }
                    
                    // Highlight missing recommended fields - check if validation exists first
                    if (result.validation && result.validation.warnings) {
                        result.validation.warnings.forEach(warning => {
                            if (typeof warning === 'string' && warning.includes('Missing recommended field')) {
                                const field = warning.replace('Missing recommended field: ', '');
                                schemaJson = schemaJson.replace(new RegExp('"' + field + '"', 'g'), '<span class="text-warning bg-warning bg-opacity-10 fw-bold">"' + field + '"</span>');
                            }
                        });
                    }
                    
                    content += '<pre class="bg-light p-3"><code>' + schemaJson + '</code></pre>';
                } else {
                    content += '<p class="text-muted">No schema data available</p>';
                }
                content += '</div>';
            } else {
                content += '<div class="mb-3">';
                content += '<h6><strong>No Schema Found</strong></h6>';
                if (result.error) {
                    content += '<p class="text-danger">Error: ' + result.error + '</p>';
                }
                content += '</div>';
            }
            
            // Set content and show modal
            modalBody.innerHTML = content;
            modal.style.display = 'block';
        }
        
        // Close modal
        function closeModal() {
            const modal = document.getElementById('detailsModal');
            modal.style.display = 'none';
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        // Copy path to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show a brief success message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#007bff';
                }, 1000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
            });
        }
        
        // Handle copy button clicks using event delegation
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('copy-path-btn')) {
                const path = event.target.getAttribute('data-path');
                if (path) {
                    copyToClipboard(path);
                }
            }
        });
    </script>
</body>
</html>