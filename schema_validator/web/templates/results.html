{% extends "base.html" %}

{% block title %}Results - Product Schema Validator{% endblock %}

{% block content %}
<div x-data="resultsApp()">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2" style="color: var(--mookee-deep-teal);"><i class="fas fa-chart-bar" style="color: var(--mookee-deep-teal);"></i> Validation Results 
                <span x-show="selectedRun" class="badge ms-2" style="background-color: var(--mookee-deep-teal); color: white;">Run #<span x-text="selectedRun?.id"></span></span>
            </h1>
            <p style="color: var(--mookee-medium-gray);">Clear insights from your validation runs</p>
        </div>
        <div x-show="results.length > 0">
            <div class="btn-group" role="group">
                <button class="btn btn-outline-success" @click="exportResults('csv')">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button class="btn btn-outline-primary" @click="exportResults('json')">
                    <i class="fas fa-file-code"></i> Export JSON
                </button>
            </div>
        </div>
    </div>
    
    <!-- Validation Runs List -->
    <div class="row">
        <div class="col-md-3" x-show="!runsCollapsed" x-transition>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-list"></i> Validation Runs</h6>
                    <button @click="toggleRunsCollapse()" class="btn btn-sm" style="background-color: var(--mookee-medium-gray); border-color: var(--mookee-medium-gray); color: white;" title="Collapse">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                        {% for run in runs %}
                        <div class="list-group-item {% if selected_run and selected_run.id == run.id %}active{% endif %}">
                            <div class="d-flex justify-content-between align-items-center py-2">
                                <a href="{{ url_for('main.results', run_id=run.id) }}" class="text-decoration-none flex-grow-1">
                                    <div>
                                        <h6 class="mb-1 small">Run #{{ run.id }}</h6>
                                        <small class="text-muted d-block">{{ run.start_time[:16] }}</small>
                                    </div>
                                    <div class="mt-1">
                                        <small class="text-muted">{{ run.processed_urls }} / {{ run.total_urls }} URLs</small>
                                    </div>
                                </a>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge small status-{{ run.status }}">{{ run.status }}</span>
                                    <button class="btn btn-sm" style="background-color: var(--mookee-error); border-color: var(--mookee-error); color: white;" @click="deleteRun({{ run.id }})" title="Delete Run">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div :class="runsCollapsed ? 'col-md-12' : 'col-md-9'">
            <!-- Expand Button (shown when runs are collapsed) -->
            <div x-show="runsCollapsed" x-transition class="mb-3">
                <button @click="toggleRunsCollapse()" class="btn" style="background-color: var(--mookee-deep-teal); border-color: var(--mookee-deep-teal); color: white;" title="Expand Validation Runs">
                    <i class="fas fa-chevron-right me-2"></i>Show Validation Runs
                </button>
            </div>
            
            {% if selected_run and results %}
            <!-- Results Summary -->
            <div class="row mb-4">
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h3 style="color: var(--mookee-deep-teal);" x-text="summary.total"></h3>
                            <p style="color: var(--mookee-charcoal);">Total</p>
                            <small style="color: var(--mookee-medium-gray);">100%</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h3 style="color: var(--mookee-mint);" x-text="summary.success"></h3>
                            <p style="color: var(--mookee-charcoal);">Success</p>
                            <small style="color: var(--mookee-medium-gray);" x-text="summary.total > 0 ? ((summary.success / summary.total) * 100).toFixed(1) + '%' : '0%'"></small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h3 style="color: var(--mookee-charcoal);" x-text="summary.warning"></h3>
                            <p style="color: var(--mookee-charcoal);">Warnings</p>
                            <small style="color: var(--mookee-medium-gray);" x-text="summary.total > 0 ? ((summary.warning / summary.total) * 100).toFixed(1) + '%' : '0%'"></small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h3 style="color: var(--mookee-error);" x-text="summary.error"></h3>
                            <p style="color: var(--mookee-charcoal);">Errors</p>
                            <small style="color: var(--mookee-medium-gray);" x-text="summary.total > 0 ? ((summary.error / summary.total) * 100).toFixed(1) + '%' : '0%'"></small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h3 style="color: var(--mookee-medium-gray);" x-text="summary.noSchema"></h3>
                            <p style="color: var(--mookee-charcoal);">No Schema</p>
                            <small style="color: var(--mookee-medium-gray);" x-text="summary.total > 0 ? ((summary.noSchema / summary.total) * 100).toFixed(1) + '%' : '0%'"></small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h3 style="color: var(--mookee-deep-teal);" x-text="summary.httpStatus"></h3>
                            <p style="color: var(--mookee-charcoal);">HTTP Errors</p>
                            <small style="color: var(--mookee-medium-gray);" x-text="summary.total > 0 ? ((summary.httpStatus / summary.total) * 100).toFixed(1) + '%' : '0%'"></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Buttons -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="btn-group">
                        <a :href="`/api/validation/results/{{ selected_run.id }}/download/csv`" class="btn" style="background-color: var(--mookee-mint); border-color: var(--mookee-mint); color: white;">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </a>
                        <a :href="`/api/validation/results/{{ selected_run.id }}/download/json`" class="btn" style="background-color: var(--mookee-deep-teal); border-color: var(--mookee-deep-teal); color: white;">
                            <i class="fas fa-file-code"></i> Export JSON
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Error and Warning Details -->
            <div class="row mb-4" x-show="summary.errorDetails.length > 0 || summary.warningDetails.length > 0">
                <!-- Error Details -->
                <div class="col-md-6" x-show="summary.errorDetails.length > 0">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-times-circle text-danger"></i> Error Breakdown</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Error Type</th>
                                            <th class="text-center">Count</th>
                                            <th class="text-center">%</th>
                                            <th class="text-center" style="width: 50px;">Help</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="error in summary.errorDetails" :key="error.type">
                                            <tr>
                                                <td>
                                                    <span x-text="error.type"></span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-danger" x-text="error.count"></span>
                                                </td>
                                                <td class="text-center" x-text="error.percentage + '%'"></td>
                                                <td class="text-center">
                                                    <button @click="showErrorHelp(error.type)" class="btn btn-sm" style="background-color: var(--mookee-deep-teal); border-color: var(--mookee-deep-teal); color: white;" title="Get help with this error">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warning Details -->
                <div class="col-md-6" x-show="summary.warningDetails.length > 0">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-exclamation-circle text-warning"></i> Warning Breakdown</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Warning Type</th>
                                            <th class="text-center">Count</th>
                                            <th class="text-center">%</th>
                                            <th class="text-center" style="width: 50px;">Help</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="warning in summary.warningDetails" :key="warning.type">
                                            <tr>
                                                <td>
                                                    <span x-text="warning.type"></span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge" style="background-color: #D4A017; color: white;" x-text="warning.count"></span>
                                                </td>
                                                <td class="text-center" x-text="warning.percentage + '%'"></td>
                                                <td class="text-center">
                                                    <button @click="showWarningHelp(warning.type)" class="btn btn-sm" style="background-color: var(--mookee-deep-teal); border-color: var(--mookee-deep-teal); color: white;" title="Get help with this warning">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Table -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Results</h5>
                        <div>
                            <select class="form-select form-select-sm" x-model="filterStatus" @change="filterResults">
                                <option value="">All Statuses</option>
                                <option value="success">Success</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                                <option value="No Schema">No Schema</option>
                                <option value="Blocked">Blocked</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px;">
                        <table class="table table-hover mb-0">
                            <style>
                                .url-cell {
                                    word-break: break-all;
                                    max-width: 400px;
                                    white-space: nowrap;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                }
                                .url-cell:hover {
                                    white-space: normal;
                                    overflow: visible;
                                    position: relative;
                                    z-index: 10;
                                    background: white;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                    border-radius: 4px;
                                    padding: 8px;
                                }
                            </style>
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th>URL</th>
                                    <th>Status</th>
                                    <th>Score</th>
                                    <th>Response Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="result in filteredResults" :key="result.id">
                                    <tr>
                                        <td class="url-cell">
                                            <a :href="result.url" target="_blank" class="text-decoration-none">
                                                <span x-text="result.url"></span>
                                                <i class="fas fa-external-link-alt fa-xs"></i>
                                            </a>
                                        </td>
                        <td>
                            <span class="badge" :class="getStatusClass(result.status)" x-text="result.status"></span>
                        </td>
                                        <td>
                                            <span x-show="result.score > 0" class="badge" 
                                                  :class="result.score >= 80 ? 'bg-success' : result.score >= 60 ? 'bg-warning' : 'bg-danger'"
                                                  x-text="result.score + '%'"></span>
                                            <span x-show="result.score === 0" class="text-muted">N/A</span>
                                        </td>
                                        <td><span x-text="result.response_time + 's'"></span></td>
                                        <td>
                                            <button class="btn btn-sm" style="background-color: var(--mookee-deep-teal); border-color: var(--mookee-deep-teal); color: white;" @click="showDetails(result)">
                                                <i class="fas fa-eye"></i> Details
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-bar fa-4x mb-3" style="color: var(--mookee-medium-gray);"></i>
                    <h5 style="color: var(--mookee-medium-gray);">No results selected</h5>
                    <p style="color: var(--mookee-medium-gray);">Select a validation run from the list to view results</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal fade modal-help" :class="{'show d-block': showHelpModal}" tabindex="-1" @click.self="showHelpModal = false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle text-info"></i> 
                        <span x-text="helpContent.title || 'Help Information'"></span>
                    </h5>
                    <button type="button" class="btn-close" @click="showHelpModal = false"></button>
                </div>
                <div class="modal-body">
                    <div x-show="helpContent.description">
                        <h6 class="text-muted mb-2">What does this mean?</h6>
                        <p class="mb-3" x-text="helpContent.description"></p>
                    </div>
                    
                    <div x-show="helpContent.fix">
                        <h6 class="text-success mb-2">How to fix it:</h6>
                        <p class="mb-3" x-text="helpContent.fix"></p>
                    </div>
                    
                    <div x-show="helpContent.example">
                        <h6 class="text-primary mb-2">Example:</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <code x-text="helpContent.example"></code>
                        </div>
                    </div>
                    
                    <div x-show="helpContent.resources && helpContent.resources.length > 0">
                        <h6 class="text-info mb-2">Learn more:</h6>
                        <ul class="list-unstyled">
                            <template x-for="resource in helpContent.resources" :key="resource">
                                <li class="mb-1">
                                    <a :href="resource" target="_blank" class="text-decoration-none">
                                        <i class="fas fa-external-link-alt fa-xs me-1"></i>
                                        <span x-text="resource"></span>
                                    </a>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" style="background-color: var(--mookee-medium-gray); border-color: var(--mookee-medium-gray); color: white;" @click="showHelpModal = false">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal Backdrop -->
    <div class="modal-backdrop fade modal-backdrop-help" :class="{'show': showHelpModal}" x-show="showHelpModal"></div>
    
    <!-- Details Modal -->
    <div class="modal fade" :class="{'show d-block': showDetailsModal}" tabindex="-1" @click.self="showDetailsModal = false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle"></i> Validation Details</h5>
                    <button type="button" class="btn-close" @click="showDetailsModal = false"></button>
                </div>
                <div class="modal-body">
                    <div x-show="selectedResult">
                        <div class="mb-3">
                            <h6>URL</h6>
                            <a :href="selectedResult?.url" target="_blank" x-text="selectedResult?.url"></a>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Status</h6>
                            <span class="badge" :class="getStatusClass(selectedResult?.status)" x-text="selectedResult?.status"></span>
                        </div>
                        
                        <div class="mb-3" x-show="selectedResult?.validation">
                            <h6>Score</h6>
                            <h3 x-text="selectedResult?.validation?.score + '%'"></h3>
                        </div>
                        
                        <div class="mb-3" x-show="selectedResult?.validation?.errors && selectedResult.validation.errors.length > 0">
                            <h6 class="text-danger">Errors</h6>
                            <template x-for="error in selectedResult?.validation?.errors">
                                <div class="alert alert-danger mb-2 d-flex align-items-center justify-content-between">
                                    <span x-text="error"></span>
                                    <button @click="showErrorHelp(error)" class="btn btn-sm" style="background-color: var(--mookee-deep-teal); border-color: var(--mookee-deep-teal); color: white;" title="Get help with this error">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                        
                        <div class="mb-3" x-show="selectedResult?.validation?.warnings && selectedResult.validation.warnings.length > 0">
                            <h6 style="color: #D4A017;">Warnings</h6>
                            <template x-for="warning in selectedResult?.validation?.warnings">
                                <div class="alert mb-2 d-flex align-items-center justify-content-between" style="background-color: #fff3cd; border-color: #D4A017; color: #856404;">
                                    <span x-text="warning"></span>
                                    <button @click="showWarningHelp(warning)" class="btn btn-sm" style="background-color: var(--mookee-deep-teal); border-color: var(--mookee-deep-teal); color: white;" title="Get help with this warning">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                        
                        <div class="mb-3" x-show="selectedResult?.schema_data">
                            <h6>Schema Data</h6>
                            <pre class="bg-light p-3 rounded"><code x-text="JSON.stringify(selectedResult?.schema_data, null, 2)"></code></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" style="background-color: var(--mookee-medium-gray); border-color: var(--mookee-medium-gray); color: white;" @click="showDetailsModal = false">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade" :class="{'show': showDetailsModal}" x-show="showDetailsModal"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function resultsApp() {
    return {
        showDetailsModal: false,
        showHelpModal: false,
        helpContent: {},
        filterStatus: '',
        runsCollapsed: true, // Start collapsed by default
        runs: {{ runs | tojson if runs else '[]' }},
        results: {{ results | tojson if results else '[]' }},
        filteredResults: [],
        selectedResult: null,
        selectedRun: {{ selected_run | tojson if selected_run else 'null' }},
        summary: {
            total: 0,
            success: 0,
            warning: 0,
            error: 0,
            noSchema: 0,
            httpStatus: 0,
            errorDetails: [],
            warningDetails: []
        },
        
        filterResults() {
            if (this.filterStatus) {
                if (this.filterStatus === 'error') {
                    // Filter for all error types - include URLs with errors (even if they also have warnings)
                    this.filteredResults = this.results.filter(r => 
                        (r.status && r.status.toLowerCase().includes('error')) ||
                        r.status === 'Blocked' ||
                        r.status === 'No Schema' ||
                        (r.status && r.status.startsWith('HTTP '))
                    );
                } else if (this.filterStatus === 'warning') {
                    // Filter for all warning types - include URLs with warnings (even if they also have errors)
                    this.filteredResults = this.results.filter(r => 
                        r.status && r.status.toLowerCase().includes('warning')
                    );
                } else {
                    this.filteredResults = this.results.filter(r => r.status === this.filterStatus);
                }
            } else {
                this.filteredResults = this.results;
            }
        },
        
            calculateSummary() {
                this.summary.total = this.results.length;
                this.summary.success = this.results.filter(r => r.status === 'success').length;
                
                // Count warnings - look for status messages containing "warning"
                this.summary.warning = this.results.filter(r => 
                    r.status && r.status.toLowerCase().includes('warning')
                ).length;
                
                // Count errors - look for status messages containing "error" or other error statuses
                this.summary.error = this.results.filter(r => 
                    (r.status && r.status.toLowerCase().includes('error')) ||
                    r.status === 'Blocked' ||
                    r.status === 'No Schema' ||
                    (r.status && r.status.startsWith('HTTP '))
                ).length;
                
                this.summary.noSchema = this.results.filter(r => r.status === 'No Schema').length;
                this.summary.httpStatus = this.results.filter(r => r.status.startsWith('HTTP ')).length;
                
                // Calculate percentages
                this.summary.successPercent = this.summary.total > 0 ? ((this.summary.success / this.summary.total) * 100).toFixed(1) : 0;
                this.summary.warningPercent = this.summary.total > 0 ? ((this.summary.warning / this.summary.total) * 100).toFixed(1) : 0;
                this.summary.errorPercent = this.summary.total > 0 ? ((this.summary.error / this.summary.total) * 100).toFixed(1) : 0;
                this.summary.noSchemaPercent = this.summary.total > 0 ? ((this.summary.noSchema / this.summary.total) * 100).toFixed(1) : 0;
                this.summary.httpStatusPercent = this.summary.total > 0 ? ((this.summary.httpStatus / this.summary.total) * 100).toFixed(1) : 0;
                
                // Calculate detailed error/warning breakdown
                this.summary.errorDetails = this.calculateErrorDetails();
                this.summary.warningDetails = this.calculateWarningDetails();
            },
            
            calculateErrorDetails() {
                const errorDetails = {};
                
                this.results.forEach(result => {
                    if (result.status && (result.status.toLowerCase().includes('error') || result.status === 'Blocked')) {
                        let errorType = 'Unknown Error';
                        
                        if (result.status === 'Blocked') {
                            errorType = 'Blocked/Crawler Timeout';
                        } else if (result.status && result.status.startsWith('HTTP ')) {
                            errorType = result.status;
                        } else {
                            // Extract specific validation errors
                            if (result.validation && result.validation.errors && result.validation.errors.length > 0) {
                                result.validation.errors.forEach(error => {
                                    const errorType = error || 'Validation Error';
                                    errorDetails[errorType] = (errorDetails[errorType] || 0) + 1;
                                });
                                return; // Skip the general categorization below
                            }
                            
                            // Fallback categorization based on error content
                            if (result.error) {
                                if (result.error.includes('Timeout')) {
                                    errorType = 'Page Load Timeout';
                                } else if (result.error.includes('net::ERR_')) {
                                    errorType = 'Network Error';
                                } else if (result.error.includes('No Product schema found')) {
                                    errorType = 'No Product Schema';
                                } else {
                                    errorType = 'Validation Error';
                                }
                            } else {
                                errorType = 'Validation Error';
                            }
                        }
                        
                        errorDetails[errorType] = (errorDetails[errorType] || 0) + 1;
                    }
                });
                
                return Object.entries(errorDetails).map(([errorType, count]) => ({
                    type: errorType,
                    count: count,
                    percentage: this.summary.total > 0 ? ((count / this.summary.total) * 100).toFixed(1) : '0.0'
                }));
            },
            
            calculateWarningDetails() {
                const warningDetails = {};
                
                this.results.forEach(result => {
                    if (result.status && result.status.toLowerCase().includes('warning')) {
                        // Extract warnings from validation object
                        if (result.validation && result.validation.warnings && result.validation.warnings.length > 0) {
                            result.validation.warnings.forEach(warning => {
                                const warningType = warning || 'Unknown Warning';
                                warningDetails[warningType] = (warningDetails[warningType] || 0) + 1;
                            });
                        } else {
                            warningDetails['Validation Warning'] = (warningDetails['Validation Warning'] || 0) + 1;
                        }
                    }
                });
                
                return Object.entries(warningDetails).map(([warningType, count]) => ({
                    type: warningType,
                    count: count,
                    percentage: this.summary.total > 0 ? ((count / this.summary.total) * 100).toFixed(1) : '0.0'
                }));
            },
        
        async refreshData() {
            // Reload the current page to get fresh data
            window.location.reload();
        },
        
        async fixRunningStatus() {
            // If the current run shows as running but has results, update it to completed
            if (this.selectedRun && this.selectedRun.status === 'running' && this.results.length > 0) {
                try {
                    const response = await fetch(`/api/validation/runs/${this.selectedRun.id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'completed' })
                    });
                    
                    if (response.ok) {
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                }
            }
        },
        
        getStatusClass(status) {
            if (!status) return 'status-error';
            
            // Handle combined status messages
            if (status.toLowerCase().includes('error') && status.toLowerCase().includes('warning')) {
                return 'status-error-warning'; // Orange for both
            } else if (status.toLowerCase().includes('warning')) {
                return 'status-warning'; // Yellow for warnings only
            } else if (status.toLowerCase().includes('error')) {
                return 'status-error'; // Red for errors only
            } else if (status === 'success') {
                return 'status-success';
            } else if (status === 'No Schema') {
                return 'status-no-schema';
            } else if (status === 'Blocked') {
                return 'status-blocked';
            } else if (status.startsWith('HTTP ')) {
                const code = status.replace('HTTP ', '');
                if (code.startsWith('4')) {
                    return 'status-http-4xx';
                } else if (code.startsWith('5')) {
                    return 'status-http-5xx';
                }
            }
            
            return 'status-error'; // Default fallback
        },
        
        showDetails(result) {
            this.selectedResult = result;
            this.showDetailsModal = true;
        },
        
        async deleteRun(runId) {
            if (confirm('Are you sure you want to delete this validation run? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/validation/runs/${runId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // Reload the page to refresh the runs list
                        window.location.reload();
                    } else {
                        const data = await response.json();
                        alert('Error deleting run: ' + data.error);
                    }
                } catch (error) {
                    alert('Error deleting run: ' + error.message);
                }
            }
        },
        
        toggleRunsCollapse() {
            this.runsCollapsed = !this.runsCollapsed;
        },
        
        async showErrorHelp(errorType) {
            await this.fetchHelpContent(errorType);
        },
        
        async showWarningHelp(warningType) {
            await this.fetchHelpContent(warningType);
        },
        
        async fetchHelpContent(errorOrWarning) {
            try {
                const response = await fetch(`/api/help/${encodeURIComponent(errorOrWarning)}`);
                if (response.ok) {
                    this.helpContent = await response.json();
                    this.showHelpModal = true;
                } else {
                    // Fallback help content
                    this.helpContent = {
                        title: "Help Information",
                        description: `This validation issue was detected: ${errorOrWarning}`,
                        fix: "Please review your schema markup and ensure it follows the schema.org Product specification.",
                        example: "Refer to the schema.org Product documentation for proper implementation guidelines.",
                        resources: ["https://schema.org/Product"]
                    };
                    this.showHelpModal = true;
                }
            } catch (error) {
                console.error('Error fetching help content:', error);
                // Fallback help content
                this.helpContent = {
                    title: "Help Information",
                    description: `This validation issue was detected: ${errorOrWarning}`,
                    fix: "Please review your schema markup and ensure it follows the schema.org Product specification.",
                    example: "Refer to the schema.org Product documentation for proper implementation guidelines.",
                    resources: ["https://schema.org/Product"]
                };
                this.showHelpModal = true;
            }
        },
        
        exportResults(format) {
            if (format === 'csv') {
                this.exportToCSV();
            } else if (format === 'json') {
                this.exportToJSON();
            }
        },
        
        exportToCSV() {
            const headers = ['URL', 'Status', 'Score', 'Response Time', 'Errors', 'Warnings'];
            const csvContent = [
                headers.join(','),
                ...this.results.map(result => [
                    `"${result.url}"`,
                    result.status,
                    result.score || 0,
                    result.response_time || 0,
                    `"${(result.validation?.errors || []).join('; ')}"`,
                    `"${(result.validation?.warnings || []).join('; ')}"`
                ].join(','))
            ].join('\n');
            
            this.downloadFile(csvContent, 'validation_results.csv', 'text/csv');
        },
        
        exportToJSON() {
            const jsonContent = JSON.stringify(this.results, null, 2);
            this.downloadFile(jsonContent, 'validation_results.json', 'application/json');
        },
        
        downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        },
        
        init() {
            this.filterResults();
            this.calculateSummary();
            
            // Fix running status if needed
            this.fixRunningStatus();
            
            // Default to the newest run if no specific run is selected
            if (!this.selectedRun && this.runs.length > 0) {
                this.selectedRun = this.runs[0]; // First run is the newest
            }
            
            // Auto-refresh every 10 seconds if validation is running
            setInterval(() => {
                if (this.selectedRun && this.selectedRun.status === 'running') {
                    this.refreshData();
                }
            }, 10000);
        }
    }
}
</script>
{% endblock %}

